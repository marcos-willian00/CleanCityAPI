// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "mysql"
    url      = env("DATABASE_URL")
}

model User {
    id           String   @id @default(cuid())
    email        String   @unique
    fullName     String
    passwordHash String
    avatar       String?
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    // Relations
    occurrences Occurrence[]
    photos      Photo[]
    sharedWith  SharedOccurrence[] @relation("sharedBy")
    sharedTo    SharedOccurrence[] @relation("sharedWith")

    @@index([email])
}

model Occurrence {
    id     String @id @default(cuid())
    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    title       String
    description String
    latitude    Float
    longitude   Float
    address     String?

    // Environmental data
    accelerometerX Float?
    accelerometerY Float?
    accelerometerZ Float?
    temperature    Float?
    humidity       Float?
    pressure       Float?

    status    OccurrenceStatus @default(PENDING)
    createdAt DateTime         @default(now())
    updatedAt DateTime         @updatedAt

    // Relations
    photos     Photo[]
    sharedWith SharedOccurrence[]

    @@index([userId])
    @@index([status])
    @@index([createdAt])
    @@index([latitude, longitude])
}

model Photo {
    id           String     @id @default(cuid())
    occurrenceId String
    occurrence   Occurrence @relation(fields: [occurrenceId], references: [id], onDelete: Cascade)
    userId       String
    user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

    fileName String
    filePath String
    fileSize Int
    mimeType String

    createdAt DateTime @default(now())

    @@index([occurrenceId])
    @@index([userId])
}

model SharedOccurrence {
    id           String     @id @default(cuid())
    occurrenceId String
    occurrence   Occurrence @relation(fields: [occurrenceId], references: [id], onDelete: Cascade)

    sharedById String
    sharedBy   User   @relation("sharedBy", fields: [sharedById], references: [id], onDelete: Cascade)

    sharedWithId String
    sharedWith   User   @relation("sharedWith", fields: [sharedWithId], references: [id], onDelete: Cascade)

    permission SharePermission @default(VIEW)
    createdAt  DateTime        @default(now())

    @@unique([occurrenceId, sharedWithId])
    @@index([sharedWithId])
    @@index([sharedById])
}

model Notification {
    id     String @id @default(cuid())
    userId String

    type    NotificationType
    title   String
    message String
    data    Json?

    read      Boolean  @default(false)
    createdAt DateTime @default(now())

    @@index([userId])
    @@index([read])
}

enum OccurrenceStatus {
    PENDING
    VERIFIED
    RESOLVED
    DISPUTED
}

enum SharePermission {
    VIEW
    EDIT
    ADMIN
}

enum NotificationType {
    OCCURRENCE_SHARED
    OCCURRENCE_VERIFIED
    OCCURRENCE_COMMENTED
    SYSTEM_NOTIFICATION
}
